<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Testing Databases with Docker | posts</title>
    <link rel="stylesheet" href="/css/style.css" />
    <link rel="stylesheet" href="/css/fonts.css" />
    
    
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-64244584-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

  </head>

  <body>
    <nav>
    <ul class="menu">
      
      <li><a href="/">posts</a></li>
      
      <li><a href="/about/">about</a></li>
      
    </ul>
    <hr/>
    </nav>

<div class="article-meta">
<h1><span class="title">Testing Databases with Docker</span></h1>

<h2 class="date">2015/09/14</h2>
</div>

<main>
<p>Databases, authentication management, metric aggregators; there's a service or API for everything.</p>
<p>There's also a place called dependency hell.</p>
<p>Dependency hell. Where it's impossible to run a test on your laptop. Where bugs are found by running a main, clicking around, and seeing what breaks. Where you cross your fingers and pray that new versions don't break everything. Where we use mocks and stubs to combat a growing technology stack.</p>
<p>But why mock when you can have the real thing?</p>
<p>This post is about using Docker in test infrastructure. To run the code you'll need:</p>
<ol>
<li>Go</li>
<li>Docker running on your host machine (not boot2docker - sorry OS X and Windows users)</li>
</ol>
<h2 id="an-example-using-postgres">An example using Postgres</h2>
<p>I work at a company that has a Go project that uses Postgres. How do you test database code? Maybe you can convince all of your employees to install Postgres with the exact same configuration. Maybe you could use SQLite to reduce dev setup times (never do this).</p>
<p>Of course with the awesomeness of Linux containers you just need to use Docker!</p>
<p>The workflow we're looking for: for each test, start a fresh instance of Postgres in a Docker container, then run the tests using it.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#a6e22e">dockerContainer</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">NewPostgresDB</span>()
<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
	<span style="color:#75715e">// handle error
</span><span style="color:#75715e"></span>}
<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">destroy</span>(<span style="color:#a6e22e">dockerContainer</span>)

<span style="color:#75715e">// run test
</span></code></pre></div><p>For our code, the Postgres struct will look like this. There's only two bits of information that it'll hold, the port the container is running on and the ID of the container.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">PostgresDB</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#75715e">// Of form &#39;host:port&#39;
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Host</span> <span style="color:#66d9ef">string</span>

	<span style="color:#75715e">// The container id assigned by docker
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">cid</span> <span style="color:#66d9ef">string</span>
}
</code></pre></div><h2 id="postgres-docker-images">Postgres&rsquo; Docker images</h2>
<p>Postgres has an <a href="https://hub.docker.com/_/postgres/">official image</a> through Docker Hub. Most databases do.</p>
<p>Starting a container is easy using Docker and will look something like the following.</p>
<pre><code class="language-nohighlight" data-lang="nohighlight">docker run -d -p $HOSTPORT:5432 -e POSTGRES_PASSWORD=$PASS postgres:$VERSION
</code></pre><p>The <code>-p</code> flag requests an exposed port and, because Postgres runs on port <code>5432</code>, we need to map <code>5432</code> to the host machine. <code>-d</code> indicates &ldquo;detached mode,&rdquo; and <code>-e</code> is used to specify environment variables.</p>
<p>The actual image allows for a bit of configuration through the env. This will be another struct.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">PostgresConfig</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#a6e22e">Password</span> <span style="color:#66d9ef">string</span>
	<span style="color:#a6e22e">Username</span> <span style="color:#66d9ef">string</span> <span style="color:#75715e">// defaults to &#34;postgres&#34;
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Database</span> <span style="color:#66d9ef">string</span> <span style="color:#75715e">// defaults to &#34;username&#34;
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Version</span>  <span style="color:#66d9ef">string</span> <span style="color:#75715e">// defaults to &#34;latest&#34;
</span><span style="color:#75715e"></span>}
</code></pre></div><p>To create an instance of Postgres, we'll determine Docker's command line arguments given a config. Then run the Docker command through Go's <code>os/exec</code> library.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">NewPostgresDB</span>(<span style="color:#a6e22e">c</span> <span style="color:#a6e22e">PostgresConfig</span>) (<span style="color:#f92672">*</span><span style="color:#a6e22e">PostgresDB</span>, <span style="color:#66d9ef">error</span>) {
	<span style="color:#a6e22e">img</span> <span style="color:#f92672">:=</span> <span style="color:#e6db74">&#34;postgres:latest&#34;</span>
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Version</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;&#34;</span> {
		<span style="color:#a6e22e">img</span> = <span style="color:#e6db74">&#34;postgres:&#34;</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Version</span>
	}

	<span style="color:#75715e">// docker&#39;s run command has the nasty habbit of pulling images if you don&#39;t have them.
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// Warn user they need to pull the image, don&#39;t automatically pull for them.
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">exec</span>.<span style="color:#a6e22e">Command</span>(<span style="color:#e6db74">&#34;docker&#34;</span>, <span style="color:#e6db74">&#34;inspect&#34;</span>, <span style="color:#a6e22e">img</span>).<span style="color:#a6e22e">Run</span>() <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;db requires docker image %s, please pull or specify a different version&#34;</span>, <span style="color:#a6e22e">img</span>)
	}

	<span style="color:#75715e">// Running on port 0 instructs the operating system to pick an available port.
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">dockerArgs</span> <span style="color:#f92672">:=</span> []<span style="color:#66d9ef">string</span>{<span style="color:#e6db74">&#34;run&#34;</span>, <span style="color:#e6db74">&#34;-d&#34;</span>, <span style="color:#e6db74">&#34;-p&#34;</span>, <span style="color:#e6db74">&#34;127.0.0.1:0:5432&#34;</span>}
	<span style="color:#a6e22e">envvars</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">string</span>]<span style="color:#66d9ef">string</span>{
		<span style="color:#e6db74">&#34;POSTGRES_PASSWORD&#34;</span>: <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Password</span>,
		<span style="color:#e6db74">&#34;POSTGRES_USER&#34;</span>:     <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Username</span>,
		<span style="color:#e6db74">&#34;POSTGRES_DB&#34;</span>:       <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Database</span>,
	}
	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">key</span>, <span style="color:#a6e22e">val</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">envvars</span> {
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">val</span> <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#34;&#34;</span> {
			<span style="color:#a6e22e">dockerArgs</span> = append(<span style="color:#a6e22e">dockerArgs</span>, <span style="color:#e6db74">&#34;-e&#34;</span>, <span style="color:#a6e22e">key</span><span style="color:#f92672">+</span><span style="color:#e6db74">&#34;=&#34;</span><span style="color:#f92672">+</span><span style="color:#a6e22e">val</span>)
		}
	}
	<span style="color:#a6e22e">dockerArgs</span> = append(<span style="color:#a6e22e">dockerArgs</span>, <span style="color:#a6e22e">img</span>)

	<span style="color:#75715e">// Start the docker container.
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">out</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">exec</span>.<span style="color:#a6e22e">Command</span>(<span style="color:#e6db74">&#34;docker&#34;</span>, <span style="color:#a6e22e">dockerArgs</span><span style="color:#f92672">...</span>).<span style="color:#a6e22e">CombinedOutput</span>()
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;docker run: %v: %s&#34;</span>, <span style="color:#a6e22e">err</span>, <span style="color:#a6e22e">out</span>)
	}
	<span style="color:#a6e22e">cid</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">strings</span>.<span style="color:#a6e22e">TrimSpace</span>(string(<span style="color:#a6e22e">out</span>))
	<span style="color:#a6e22e">db</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">PostgresDB</span>{<span style="color:#a6e22e">cid</span>: <span style="color:#a6e22e">cid</span>}

	<span style="color:#a6e22e">db</span>.<span style="color:#a6e22e">Host</span>, <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">portMapping</span>(<span style="color:#a6e22e">cid</span>, <span style="color:#e6db74">&#34;5432/tcp&#34;</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">db</span>.<span style="color:#a6e22e">Close</span>()
		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">err</span>
	}
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">db</span>, <span style="color:#66d9ef">nil</span>
}
</code></pre></div><p>The host address specified above is <code>127.0.0.1:0</code>. Port 0 is a way of telling the operating system to pick any available port. For testing it's nice to not hard code an explicit port in case the person running the tests has a conflicting service (like an actually Postgres database).</p>
<p><code>docker inspect</code> allows us figure out what port the operating system chose. This returns a giant JSON object with, among other things, network settings for the running container.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">portMapping</span>(<span style="color:#a6e22e">cid</span>, <span style="color:#a6e22e">containerPort</span> <span style="color:#66d9ef">string</span>) (<span style="color:#a6e22e">hostAddr</span> <span style="color:#66d9ef">string</span>, <span style="color:#a6e22e">err</span> <span style="color:#66d9ef">error</span>) {
	<span style="color:#a6e22e">out</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">exec</span>.<span style="color:#a6e22e">Command</span>(<span style="color:#e6db74">&#34;docker&#34;</span>, <span style="color:#e6db74">&#34;inspect&#34;</span>, <span style="color:#a6e22e">cid</span>).<span style="color:#a6e22e">CombinedOutput</span>()
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;docker inspect: %v: %s&#34;</span>, <span style="color:#a6e22e">err</span>, <span style="color:#a6e22e">out</span>)
	}

	<span style="color:#75715e">// anonymous struct for unmarshalling JSON into
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">inspectResp</span> []<span style="color:#66d9ef">struct</span> {
		<span style="color:#a6e22e">NetworkSettings</span> <span style="color:#66d9ef">struct</span> {
			<span style="color:#a6e22e">Ports</span> <span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">string</span>][]<span style="color:#66d9ef">struct</span> {
				<span style="color:#a6e22e">HostIp</span>   <span style="color:#66d9ef">string</span>
				<span style="color:#a6e22e">HostPort</span> <span style="color:#66d9ef">string</span>
			}
		}
	}
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">json</span>.<span style="color:#a6e22e">Unmarshal</span>(<span style="color:#a6e22e">out</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">inspectResp</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;decoding docker inspect result failed: %v: %s&#34;</span>, <span style="color:#a6e22e">err</span>, <span style="color:#a6e22e">out</span>)
	}
	<span style="color:#66d9ef">if</span> len(<span style="color:#a6e22e">inspectResp</span>) <span style="color:#f92672">!=</span> <span style="color:#ae81ff">1</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;expected one inspect result, got %d&#34;</span>, len(<span style="color:#a6e22e">inspectResp</span>))
	}
	<span style="color:#a6e22e">ports</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">inspectResp</span>[<span style="color:#ae81ff">0</span>].<span style="color:#a6e22e">NetworkSettings</span>.<span style="color:#a6e22e">Ports</span>[<span style="color:#a6e22e">containerPort</span>]
	<span style="color:#66d9ef">if</span> len(<span style="color:#a6e22e">ports</span>) <span style="color:#f92672">!=</span> <span style="color:#ae81ff">1</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;expected one port mapping, got %d&#34;</span>, len(<span style="color:#a6e22e">ports</span>))
	}
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">ports</span>[<span style="color:#ae81ff">0</span>].<span style="color:#a6e22e">HostIp</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;:&#34;</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">ports</span>[<span style="color:#ae81ff">0</span>].<span style="color:#a6e22e">HostPort</span>, <span style="color:#66d9ef">nil</span>
}
</code></pre></div><p>Finally, closing the database should result in the entire container being removed. Again, we'll just use <code>os/exec</code> to call Docker.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// Close removes the container running the postgres database.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">db</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">PostgresDB</span>) <span style="color:#a6e22e">Close</span>() <span style="color:#66d9ef">error</span> {
	<span style="color:#a6e22e">out</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">exec</span>.<span style="color:#a6e22e">Command</span>(<span style="color:#e6db74">&#34;docker&#34;</span>, <span style="color:#e6db74">&#34;rm&#34;</span>, <span style="color:#e6db74">&#34;-f&#34;</span>, <span style="color:#a6e22e">db</span>.<span style="color:#a6e22e">cid</span>).<span style="color:#a6e22e">CombinedOutput</span>()
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;docker rm: %v: %s&#34;</span>, <span style="color:#a6e22e">err</span>, <span style="color:#a6e22e">out</span>)
	}
	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
}
</code></pre></div><h2 id="writing-a-test-helper">Writing a test helper</h2>
<p>Go tests always have a signature like this:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">TestXyz</span>(<span style="color:#a6e22e">t</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">testing</span>.<span style="color:#a6e22e">T</span>)
</code></pre></div><p>We want to write tests that take a database connection as well. Something that looks like this:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">DBTest</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">t</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">testing</span>.<span style="color:#a6e22e">T</span>, <span style="color:#a6e22e">conn</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">sql</span>.<span style="color:#a6e22e">DB</span>)
</code></pre></div><p>So let's write a function to run a <code>DBTest</code>. This steps will be</p>
<ol>
<li>Create a container</li>
<li>Connect to the container</li>
<li>Run a test with the connection</li>
<li>Clean up the container</li>
</ol>
<p>Importing the <a href="https://github.com/lib/pq"><code>github.com/lib/pq</code></a> driver is enough to connect to the container. While the code we used before will create and clean up a new instance of Postgres for each test.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">import</span> (
	<span style="color:#75715e">// other imports
</span><span style="color:#75715e"></span>
	<span style="color:#a6e22e">_</span> <span style="color:#e6db74">&#34;github.com/lib/pq&#34;</span> <span style="color:#75715e">// &#34;empty import&#34; to register driver with database/sql
</span><span style="color:#75715e"></span>)

<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">DBTest</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">t</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">testing</span>.<span style="color:#a6e22e">T</span>, <span style="color:#a6e22e">conn</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">sql</span>.<span style="color:#a6e22e">DB</span>)

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">RunDBTest</span>(<span style="color:#a6e22e">t</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">testing</span>.<span style="color:#a6e22e">T</span>, <span style="color:#a6e22e">dbVersion</span> <span style="color:#66d9ef">string</span>, <span style="color:#a6e22e">test</span> <span style="color:#a6e22e">DBTest</span>) {
	<span style="color:#a6e22e">c</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">PostgresConfig</span>{<span style="color:#e6db74">&#34;pass&#34;</span>, <span style="color:#e6db74">&#34;eric&#34;</span>, <span style="color:#e6db74">&#34;postgrestest&#34;</span>, <span style="color:#a6e22e">dbVersion</span>}

	<span style="color:#75715e">// create a postgres container
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">db</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">NewPostgresDB</span>(<span style="color:#a6e22e">c</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">Fatal</span>(<span style="color:#a6e22e">err</span>)
	}
	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">db</span>.<span style="color:#a6e22e">Close</span>() <span style="color:#75715e">// destroy the postgres container after the test
</span><span style="color:#75715e"></span>
	<span style="color:#75715e">// create a connection URL
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// http://www.postgresql.org/docs/current/static/libpq-connect.html#LIBPQ-CONNSTRING
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">connURL</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">url</span>.<span style="color:#a6e22e">URL</span>{
		<span style="color:#a6e22e">Scheme</span>:   <span style="color:#e6db74">&#34;postgres&#34;</span>,
		<span style="color:#a6e22e">User</span>:     <span style="color:#a6e22e">url</span>.<span style="color:#a6e22e">UserPassword</span>(<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Username</span>, <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Password</span>),
		<span style="color:#a6e22e">Host</span>:     <span style="color:#a6e22e">db</span>.<span style="color:#a6e22e">Host</span>,
		<span style="color:#a6e22e">Path</span>:     <span style="color:#e6db74">&#34;/&#34;</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Database</span>,
		<span style="color:#a6e22e">RawQuery</span>: <span style="color:#e6db74">&#34;sslmode=disable&#34;</span>,
	}

	<span style="color:#75715e">// connect to database
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">conn</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">sql</span>.<span style="color:#a6e22e">Open</span>(<span style="color:#e6db74">&#34;postgres&#34;</span>, <span style="color:#a6e22e">connURL</span>.<span style="color:#a6e22e">String</span>())
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">Error</span>(<span style="color:#a6e22e">err</span>)
		<span style="color:#66d9ef">return</span>
	}
	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">conn</span>.<span style="color:#a6e22e">Close</span>()

	<span style="color:#75715e">// ping the database until it comes up
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">timeout</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Now</span>().<span style="color:#a6e22e">Add</span>(<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">20</span>)
	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Now</span>().<span style="color:#a6e22e">Before</span>(<span style="color:#a6e22e">timeout</span>) {
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">conn</span>.<span style="color:#a6e22e">Ping</span>(); <span style="color:#a6e22e">err</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#75715e">// yay! we&#39;ve connected to the database, time to run the test
</span><span style="color:#75715e"></span>			<span style="color:#a6e22e">test</span>(<span style="color:#a6e22e">t</span>, <span style="color:#a6e22e">conn</span>)
			<span style="color:#66d9ef">return</span>
		}
		<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Sleep</span>(<span style="color:#ae81ff">100</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Millisecond</span>)
	}
	<span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;failed to connect to database: %v&#34;</span>, <span style="color:#a6e22e">err</span>)
}
</code></pre></div><h2 id="time-to-write-the-tests">Time to write the tests</h2>
<p>Finally we can just write tests that adhere to <code>DBTest</code>'s function signature and run them with <code>RunDBTest</code>. Let's test creating a table and inserting a record.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">dbtest</span>

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;database/sql&#34;</span>
	<span style="color:#e6db74">&#34;testing&#34;</span>

	<span style="color:#a6e22e">_</span> <span style="color:#e6db74">&#34;github.com/lib/pq&#34;</span>
)

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">createTable</span>(<span style="color:#a6e22e">conn</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">sql</span>.<span style="color:#a6e22e">DB</span>) <span style="color:#66d9ef">error</span> {
	<span style="color:#a6e22e">statement</span> <span style="color:#f92672">:=</span> <span style="color:#e6db74">`</span><span style="color:#e6db74">
</span><span style="color:#e6db74">		CREATE TABLE Worker (
</span><span style="color:#e6db74">			WorkerId SERIAL PRIMARY KEY,
</span><span style="color:#e6db74">			Host     TEXT NOT NULL,
</span><span style="color:#e6db74">			UsingTLS BOOLEAN NOT NULL
</span><span style="color:#e6db74">		);</span><span style="color:#e6db74">`</span>
	<span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">conn</span>.<span style="color:#a6e22e">Exec</span>(<span style="color:#a6e22e">statement</span>)
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
}

<span style="color:#75715e">// Test creating a table
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">testCreateTable</span>(<span style="color:#a6e22e">t</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">testing</span>.<span style="color:#a6e22e">T</span>, <span style="color:#a6e22e">conn</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">sql</span>.<span style="color:#a6e22e">DB</span>) {
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">createTable</span>(<span style="color:#a6e22e">conn</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">Error</span>(<span style="color:#a6e22e">err</span>)
	}
}

<span style="color:#75715e">// Test creating a table then inserting a row
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">testInsertWorker</span>(<span style="color:#a6e22e">t</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">testing</span>.<span style="color:#a6e22e">T</span>, <span style="color:#a6e22e">conn</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">sql</span>.<span style="color:#a6e22e">DB</span>) {
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">createTable</span>(<span style="color:#a6e22e">conn</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">Error</span>(<span style="color:#a6e22e">err</span>)
		<span style="color:#66d9ef">return</span>
	}
	<span style="color:#a6e22e">insertWorker</span> <span style="color:#f92672">:=</span> <span style="color:#e6db74">`</span><span style="color:#e6db74">INSERT INTO Worker (Host, UsingTLS) VALUES ($1, $2);</span><span style="color:#e6db74">`</span>
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">conn</span>.<span style="color:#a6e22e">Exec</span>(<span style="color:#a6e22e">insertWorker</span>, <span style="color:#e6db74">&#34;10.0.0.3&#34;</span>, <span style="color:#66d9ef">true</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">Error</span>(<span style="color:#a6e22e">err</span>)
	}
}

<span style="color:#75715e">// Test multiple versions of Postgres
</span><span style="color:#75715e"></span><span style="color:#66d9ef">const</span> (
	<span style="color:#a6e22e">version94</span> = <span style="color:#e6db74">&#34;9.4&#34;</span>
	<span style="color:#a6e22e">version95</span> = <span style="color:#e6db74">&#34;9.5&#34;</span>
)

<span style="color:#75715e">// The actual Go tests just immediately call RunDBTest
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">TestCreateTable94</span>(<span style="color:#a6e22e">t</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">testing</span>.<span style="color:#a6e22e">T</span>)  { <span style="color:#a6e22e">RunDBTest</span>(<span style="color:#a6e22e">t</span>, <span style="color:#a6e22e">version94</span>, <span style="color:#a6e22e">testCreateTable</span>) }
<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">TestCreateTable95</span>(<span style="color:#a6e22e">t</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">testing</span>.<span style="color:#a6e22e">T</span>)  { <span style="color:#a6e22e">RunDBTest</span>(<span style="color:#a6e22e">t</span>, <span style="color:#a6e22e">version95</span>, <span style="color:#a6e22e">testCreateTable</span>) }
<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">TestInsertWorker94</span>(<span style="color:#a6e22e">t</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">testing</span>.<span style="color:#a6e22e">T</span>) { <span style="color:#a6e22e">RunDBTest</span>(<span style="color:#a6e22e">t</span>, <span style="color:#a6e22e">version94</span>, <span style="color:#a6e22e">testInsertWorker</span>) }
<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">TestInsertWorker95</span>(<span style="color:#a6e22e">t</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">testing</span>.<span style="color:#a6e22e">T</span>) { <span style="color:#a6e22e">RunDBTest</span>(<span style="color:#a6e22e">t</span>, <span style="color:#a6e22e">version95</span>, <span style="color:#a6e22e">testInsertWorker</span>) }
</code></pre></div><p>This setup enables a bunch of cool things like tests against different versions of Postgres. Once we (or importantly, one of our coworkers) have pulled the correct Postgres images, we just have to run <code>go test</code>. The only dependencies are Go and Docker.</p>
<pre><code class="language-nohighlight" data-lang="nohighlight">$ go test -v
=== RUN   TestCreateTable94
--- PASS: TestCreateTable94 (6.21s)
=== RUN   TestCreateTable95
--- PASS: TestCreateTable95 (6.09s)
=== RUN   TestInsertWorker94
--- PASS: TestInsertWorker94 (5.97s)
=== RUN   TestInsertWorker95
--- PASS: TestInsertWorker95 (5.83s)
PASS
ok  	_/p/go/dbtest	24.106s
</code></pre><p>It's not blindingly fast, but most of the overhead is from Postgres&rsquo; <a href="https://github.com/docker-library/postgres/blob/87b8be7e9b324ff2bcd6545d05895fac8f012dac/9.5/docker-entrypoint.sh">initialization</a>, not Docker. If you know your configuration ahead of time, it's easy to make a custom Docker image and speed things up.</p>
<p>Importantly, we're testing against full installations of Postgres 9.4 and 9.5. No mocks, no sqlite.</p>
<h2 id="things-other-than-databases">Things other than databases</h2>
<p>This strategy is absolutely <em>not</em> limited to databases, and gets even cooler when you expand past just hitting an exposed port.</p>
<p>With a little bit of imagination you can use Docker to test your Nginx config files, your RabbitMQ client, your WordPress plugins. For each test you'll get a fresh installation of the thing your testing against, and all a coworker needs to do is download a Docker image.</p>
<p>So mount your files, use <a href="https://github.com/bradfitz/http2/blob/f8202bc903bda493ebba4aa54922d78430c2c42f/http2_test.go#L96-L102"><code>--net=host</code></a>, and who knows, you might even have a little fun writing tests.</p>

</main>

  <footer>
  
  
  </footer>
  </body>
</html>

